<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Selector de equipo</title>
</head>
<body>
  <label>
    Temporada:
    <select id="seasonSelect"><option value="">-- elegir temporada --</option></select>
  </label>

  <label>
    Categoría:
    <select id="categorySelect"><option value="">-- elegir categoría --</option></select>
  </label>

  <label>
    Equipo:
    <select id="teamSelect"><option value="">-- elegir equipo --</option></select>
  </label>

  <div id="createArea" style="display:none; margin-top:8px;">
    <input id="newTeamName" placeholder="Nombre del equipo" />
    <button id="createBtn">Crear y asociar</button>
  </div>

  <script>
    async function fetchJSON(url) {
      const res = await fetch(url);
      if (!res.ok) throw new Error('HTTP ' + res.status);
      return res.json();
    }

    const seasonSelect = document.getElementById('seasonSelect');
    const categorySelect = document.getElementById('categorySelect');
    const teamSelect = document.getElementById('teamSelect');
    const createArea = document.getElementById('createArea');
    const newTeamName = document.getElementById('newTeamName');
    const createBtn = document.getElementById('createBtn');

    // cargar temporadas y categorías
    Promise.all([fetchJSON('/src/api/seasons.php'), fetchJSON('/src/api/categories.php')])
      .then(([seasons, categories]) => {
        seasons.forEach(s => {
          const o = document.createElement('option'); o.value = s.id; o.textContent = s.name; seasonSelect.appendChild(o);
        });
        categories.forEach(c => {
          const o = document.createElement('option'); o.value = c.id; o.textContent = c.name; categorySelect.appendChild(o);
        });
      }).catch(console.error);

    function clearTeams() {
      teamSelect.innerHTML = '<option value="">-- elegir equipo --</option>';
    }

    async function loadTeams() {
      const s = seasonSelect.value, c = categorySelect.value;
      clearTeams();
      if (!s || !c) return;
      try {
        const teams = await fetchJSON(`/src/api/teams.php?season=${s}&category=${c}`);
        teams.forEach(t => {
          const o = document.createElement('option'); o.value = t.id; o.textContent = t.name; teamSelect.appendChild(o);
        });
        // opción crear nuevo
        const o = document.createElement('option'); o.value = '__create_new'; o.textContent = '+ Crear nuevo equipo'; teamSelect.appendChild(o);
      } catch (e) {
        console.error(e);
      }
    }

    seasonSelect.addEventListener('change', loadTeams);
    categorySelect.addEventListener('change', loadTeams);

    teamSelect.addEventListener('change', () => {
      if (teamSelect.value === '__create_new') {
        createArea.style.display = 'block';
      } else {
        createArea.style.display = 'none';
      }
    });

    createBtn.addEventListener('click', async () => {
      const name = newTeamName.value.trim();
      if (!name) return alert('Escribe nombre');
      const s = seasonSelect.value, c = categorySelect.value;
      if (!s || !c) return alert('Selecciona temporada y categoría');

      // crear equipo
      const res = await fetch('/src/api/create_team.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ name })
      });
      const team = await res.json();
      if (!team.id) return alert('Error creando equipo');

      // asociar participación
      await fetch('/src/api/create_participation.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ team_id: team.id, category_id: Number(c), season_id: Number(s) })
      });

      // añadir al select y seleccionar
      const o = document.createElement('option'); o.value = team.id; o.textContent = team.name;
      teamSelect.appendChild(o);
      teamSelect.value = team.id;
      createArea.style.display = 'none';
      newTeamName.value = '';
    });
  </script>
</body>
</html>